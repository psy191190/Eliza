<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Paradigm INFT Downloader (0G)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- --------------------------------------------------- -->
<!-- 0  Load libraries                                    -->
<!-- --------------------------------------------------- -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.min.js"
        integrity="sha384-+rn3pjFVX8Qw3c8F46T1ZMWGmXK7yJhKzo1z89Z1la2dFwPFR0bBvJY3Re+j6TLo"
        crossorigin="anonymous"></script>

<!-- Uncomment the line below if you later want to use the official 0G TS SDK -->
<!-- <script src="https://cdn.jsdelivr.net/npm/@0glabs/0g-ts-sdk/dist/0g-ts-sdk.min.js"></script> -->

<style>
  body {font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;margin:0;padding:2rem;}
  .container {max-width:800px;margin:auto;background:#fff;padding:2rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.08);}
  button {padding:.5rem 1rem;font-size:1rem;cursor:pointer;border:none;border-radius:4px;background:#007bff;color:#fff;}
  button:hover {background:#0056b3;}
  .inft-item {border:1px solid #e0e0e0;border-radius:6px;margin-bottom:1rem;padding:1rem;background:#fafafa;}
  .inft-item h3 {margin:0 0 .5rem;}
  .status {margin-top:1rem;color:#555;}
  .hidden {display:none;}
</style>
</head>

<body>
<div class="container">
  <h1>Paradigm INFT Downloader (0G)</h1>

  <!-- --------------------------------------------------- -->
  <!-- 1  Wallet connection UI                           -->
  <!-- --------------------------------------------------- -->
  <div id="wallet-section">
    <button id="connectBtn">Connect Wallet</button>
    <span id="walletAddr" style="margin-left:1rem;font-weight:bold;"></span>
  </div>

  <!-- --------------------------------------------------- -->
  <!-- 2  INFT list (populated after connection)        -->
  <!-- --------------------------------------------------- -->
  <div id="inftList" class="hidden">
    <h2>Your INFTs</h2>
    <div id="items"></div>
  </div>

  <div class="status" id="status"></div>
</div>

<script>
/* ==========================================================
   Configuration – EVERYTHING YOU PROVIDED IS HERE
   ========================================================== */
const RPC_URL        = "https://evmrpc.0g.ai";                     // 0G Mainnet RPC
const CONTRACT_ADDR  = "0x57e463BF845cf328715446b9246fFa536B671A10"; // INFT contract
const CONTRACT_ABI = [
  "function tokenURI(uint256 tokenId) view returns (string)",
  "function ownerOf(uint256 tokenId) view returns (address)",
  "function balanceOf(address owner) view returns (uint256)",
  "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)"
];

// Full token IDs you own (exact values taken from the tx data you posted)
const KNOWN_TOKEN_IDS = [
  "0x4884f4590000000000000000000000000000000000000000000000000000000000000001",
  "0x4884f4590000000000000000000000000000000000000000000000000000000000000002",
  "0x4884f4590000000000000000000000000000000000000000000000000000000000000003",
  "0x4884f4590000000000000000000000000000000000000000000000000000000000000004"
];

/* ==========================================================
   UI helpers
   ========================================================== */
const setStatus = (msg, isError = false) => {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.style.color = isError ? 'red' : '#555';
};

const shorten = (addr) => addr.slice(0,6) + "…" + addr.slice(-4);

/* ==========================================================
   Main logic
   ========================================================== */
let provider, signer, contract, userAddress;

document.getElementById('connectBtn').addEventListener('click', async () => {
  try {
    // 1 Connect to injected provider (MetaMask, TrustWallet, etc.)
    if (!window.ethereum) throw new Error('No injected Ethereum provider found. Install MetaMask.');
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.JsonRpcProvider(RPC_URL);
    signer   = provider.getSigner();               // uses the injected account
    userAddress = await signer.getAddress();

    // UI updates
    document.getElementById('walletAddr').textContent = shorten(userAddress);
    setStatus('Wallet connected, loading your INFTs...');
    document.getElementById('connectBtn').disabled = true;

    // 2 Instantiate the contract
    contract = new ethers.Contract(CONTRACT_ADDR, CONTRACT_ABI, provider);

    // 3 Load each token (you can also autodiscover via balanceOf if you prefer)
    const itemsContainer = document.getElementById('items');
    itemsContainer.innerHTML = ''; // clear any previous content

    for (const tokenIdHex of KNOWN_TOKEN_IDS) {
      const tokenId = ethers.toBigInt(tokenIdHex);
      const itemDiv = document.createElement('div');
      itemDiv.className = 'inft-item';
      itemDiv.id = `token-${tokenIdHex}`;
      itemDiv.innerHTML = `<h3>Token ${tokenIdHex}</h3><p>Loading…</p>`;
      itemsContainer.appendChild(itemDiv);

      // ----- fetch metadata -------------------------------------------------
      try {
        // Verify ownership (optional, just for safety)
        const owner = await contract.ownerOf(tokenId);
        if (owner.toLowerCase() !== userAddress.toLowerCase()) {
          itemDiv.innerHTML = `<h3>Token ${tokenIdHex}</h3><p style="color:red;">You are not the owner of this token.</p>`;
          continue;
        }

        // tokenURI may return raw JSON (as in your example) or an ipfs:// URI
        const rawUri = await contract.tokenURI(tokenId);
        let metadata;

        if (rawUri.startsWith('ipfs://')) {
          const gateway = 'https://gateway.ipfs.io/ipfs/' + rawUri.slice(7);
          const resp = await fetch(gateway);
          metadata = await resp.json();
        } else {
          // Try to parse directly; if it fails, treat the string as a URL and fetch it.
          try {
            metadata = JSON.parse(rawUri);
          } catch (_) {
            const resp = await fetch(rawUri);
            metadata = await resp.json();
          }
        }

        // ----- extract CID and file name ------------------------------------
        const attrs = metadata.attributes || [];
        const cidAttr   = attrs.find(a => a.trait_type === 'Storage CID');
        const nameAttr  = attrs.find(a => a.trait_type === 'File Name');

        if (!cidAttr) throw new Error('Storage CID not found in metadata.');
        const cid = cidAttr.value;
        const fileName = nameAttr?.value || `inft_${tokenIdHex}.txt`;
        const downloadLink = `https://gateway.ipfs.io/ipfs/${cid}`;

        // ----- render UI ----------------------------------------------------
        itemDiv.innerHTML = `
          <h3>Token ${tokenIdHex}</h3>
          <p><strong>File:</strong> ${fileName}</p>
          <p><strong>CID:</strong> ${cid}</p>
          <button class="downloadBtn">Download ${fileName}</button>
          <p class="dlStatus hidden"></p>
        `;

        // ----- download handler ---------------------------------------------
        const dlBtn = itemDiv.querySelector('.downloadBtn');
        const dlStatus = itemDiv.querySelector('.dlStatus');

        dlBtn.addEventListener('click', async () => {
          try {
            dlStatus.textContent = 'Fetching…';
            dlStatus.classList.remove('hidden');

            const resp = await fetch(downloadLink);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const blob = await resp.blob();

            // Create a temporary link to trigger the download
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            dlStatus.textContent = ' Download started';
          } catch (e) {
            dlStatus.textContent = ' Download failed: ' + e.message;
            dlStatus.style.color = 'red';
          }
        });

      } catch (e) {
        console.error(e);
        itemDiv.innerHTML = `<h3>Token ${tokenIdHex}</h3><p style="color:red;">Error: ${e.message}</p>`;
      }
    }

    // Show the list container once everything is processed
    document.getElementById('inftList').classList.remove('hidden');
    setStatus('All tokens processed.', false);

  } catch (e) {
    console.error(e);
    setStatus('Error: ' + e.message, true);
  }
});
</script>
</body>
</html>